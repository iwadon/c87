# OCNメール無暗号化事件

POODLEは最後ではなかった。
年末のクソ締め切りが差し迫る忙しい12月中旬、
なぜかいくつもセキュリティ案件が湧き上がった。
12月19日に予定されているOCNメールの仕様変更は、
そのなかで最も深刻な被害が懸念されるのは事件化前事件(12月15日現在)である。

## 概要

OCNメールがセキュリティ向上を目的に**APOPプロトコルを廃止**した。
APOPはすでに脆弱であることが知られていて、APOPを廃止するのは(*だいぶ遅いけど*)妥当な判断である。
しかし、APOP廃止後の変更設定の案内が**まさかの平文送信**だったことが大問題になった。
APOPの脆弱性勧告は、当然ながらAPOPを廃止してSSLを使えという話だ。
しかしOCNは、SSLを上級者向け機能と位置づけて、「接続に失敗したらSSLを切れ」と指示している。
**接続に失敗した時**というのは、通信が不安定なども考えられるが、当然**中間者攻撃を受けている**場合も含まれる。
むしろ接続が失敗した場合は**経路上の攻撃**をまず最初に疑うべきで、当然SSLを切るは**最もやってはいけない**ことだ。
日本の通信を牛耳ってきたNTTの関連会社が取ってよい対応ではない。

## APOPからSSLへ

APOPは、もともとパスワードを**平文で**送っていたPOPを改良し、
パスワードをMD5によるチャレンジレスポンスで暗号化して送るプロトコルだ。
チャレンジレスポンスなので毎回ネットワークに流れるパスワードは変化し、平文よりはだいぶ安全であった。
ただし本文の受信は全く暗号化されない。
この暗号化方式もMD5自体の弱さにより、解読できてしまうことが2007年に実証されてしまった。
これを受け、IPAは[APOPの脆弱性を喚起](https://www.ipa.go.jp/security/vuln/200704_APOP.html)し、通信そのものをSSL化する**POP over SSL**やWebメールを使うことを推奨した。
OCNは3年後の2010年にやっと[SSLに対応し](http://www.ocn.ne.jp/info/announce/2010/11/25_2.html?am20101209)、
最終的に2014年に[APOPの廃止](http://www.ocn.ne.jp/info/announce/2014/09/17_1.html)を決めた。

## OCNの問題点

しかし、OCNの[メール設定の案内](http://tech.support.ntt.com/ocn/mail/support/setup/winmail60.html#step-14)はSSLを使わないように案内されている。
さらに悪いことに、WiFiを使う可能性の高い[Android2.x用の案内](http://tech.support.ntt.com/ocn/mail/support/setup/android2.html#step-4)もSSLを使わない設定例になっており、
[iOS用の案内](http://tech.support.ntt.com/ocn/mail/support/setup/ios7.html#step-10)はSSL接続に失敗したらSSLを切れと指示されている。
唯一マトモなのは[Android4.x用の設定](http://tech.support.ntt.com/ocn/mail/support/setup/android4.html#step-4)だ。
このような設定例は安全側に倒すべきで、ユーザが無知であろうと安全になるように書くべきだ。
当然SSLが有効になる設定例を書くべきだし、SSLは切ってはいけないものだと伝えなければならない。

この問題が大きな話題になる少し前、OCNは[メールパスワードの定期変更をしないユーザの締め出し](http://megalodon.jp/2014-1112-2122-18/www.ocn.ne.jp/info/announce/2014/11/11_1.html)を行うと発表した。
現在では[定期変更の方針は削除](http:///www.ocn.ne.jp/info/announce/2014/11/11_1.html)されているが、
この方針は**非SSLでパスワードが一切保護されない**ことを、
**パスワードを定期変更しないユーザの責任**に転嫁することを目的としているのではないかと邪推してしまう。

## メールパスワードが漏れた場合のリスク

メールパスワードが漏れた場合、当然攻撃者によりメールの受信が可能になる。
その場合、攻撃者にメールが読まれることは、単純にプライバシーが流出するだけではない。

現在多くのWebサービスは**本人しかメールが受信できない**という前提に基づいてセキュリティ設計がされている。
例えばログインパスワードを忘れた場合、登録されたメールアドレスに対して、ワンタイムトークンをつけたパスワード変更用URLをメール送信する。
例えば登録メールアドレスを変更するときは、以前のメールアドレスに本当に変更していいかを確認するURLを送る。
セキュリティをきちんと考慮したWebサービスであればあるほど、メール受信に強く依存した傾向がある。
ログイン機構をFacebookのOAuthに任せている場合も、やはりFacebookの個人確認の最終手段はメールアドレスの受信可能性なのである。
今の世界ではそれ以上に個人を識別できるチャネルがないのだ。
メールアドレスの陥落はあらゆるWebサービスのアカウントが死んだことを意味するのだ。

Webサービスを運営する側の立場から見ると、あるプロバイダのメールシステムに問題がある場合、
そのプロバイダのメールアドレスを使っているユーザからのリクエストを一切信用できなくなるのである。

## どうするべきか

当然ながらSSLを有効にするよう、絶対にSSLを切ってはならないよう案内するべきだ。
OCNはSSL接続を上級者向け機能と位置づけているが、この考えは今すぐ改めなければならない。
通信の安全を守ることはすべてのユーザが等しく持つ権利でなければならない。
SSLのサーバ負荷を嫌っているのか分からないが、無知な人間にリスクを負わせるなど言語道断だ。
むしろSSLではない接続をすべて拒否するように変更するべきだ。

HTTP2の流れで「すべてhttps」が当然になっていく世の中で、
通信の最も基礎部分を担っているプロバイダがこのような間違いを犯すというのは、情けないとしか言いようがない。

## 総括

当初は[12/19に廃止する](http://megalodon.jp/2014-1023-0936-16/www.ocn.ne.jp/info/announce/2014/09/17_1.html)とされていたが、問題提起により[12/19以降に順次廃止](http://www.ocn.ne.jp/info/announce/2014/09/17_1.html)と変更され、実際12/19を過ぎた現在もAPOPが終了した報告はなく、いったん大混乱に陥ることは避けられた。
しかし、今でも設定案内はSSLをデフォルトにしておらず、このまま本当に*順次*廃止されてしまった場合、
大量の平文パスワードがネットワーク上に乗ることになる。
余談を許さない状況と言える。

ユーザとしては必ずSSLで接続することも意味があるが、何よりもう今更**メールなんか使わない**のが最も効果的だ。
メールが必要なら**Webメール**を使おう。SSLに対応していないWebメールなんて無いはずだ。
プロバイダメールのような信頼できないものより**Gmail**の方が圧倒的によい。
自前ドメインのメールアドレスも使わないほうが良い。
なぜなら自前ドメインは**ドメインごと陥落する**可能性があるからだ。
過去に、レジストラをソーシャルハックされドメインのネームサーバ設定を変更され、偽のメールサーバを建てられ、twitterアカウントを奪われた事例があった。
一方Gmailがドメインごと陥落することはまず考えられない。
これでも最後に、Gmailを取得するのにメールアドレスが必要という問題が残っているが、そこはもうどうしようもなさそうである。
Gmailの登録をプロバイダメールアドレスでして、プロバイダメールはすべてGmailに転送するよう設定し、プロバイダメールのPOPでの受信をすべて止めるのが良いと思われる。
ところでホスト間のSMTPはきちんと暗号化されているのだろうか・・・

やっぱり今すぐメールっていうものは滅びるべきだと思う。
